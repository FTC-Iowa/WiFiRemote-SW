<html>
	<head>
		<title>WiFi Remote - Server Settings</title>
		<script type="text/javascript">
			var serverConfig;

			function httpGetAsync(theUrl, headers, callback) {
					var xmlHttp = new XMLHttpRequest();
					xmlHttp.onreadystatechange = function() { 
							if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
									callback(xmlHttp.responseText);
					}
					xmlHttp.open("GET", theUrl, true); // true for asynchronous
					xmlHttp.setRequestHeader("Cache-Control", "no-cache");
					
					if(headers != null) {
						for(i = 0; i < headers.length; i++) {
							xmlHttp.setRequestHeader(headers[i].name, headers[i].value);
						}
					}

					xmlHttp.send(null);
			}
			function getConfig() {
				setStatus("Loading Server Config...");
				httpGetAsync("server_config", null, function(response) {
					setConfig(JSON.parse(response));

					setStatus("");
				});
			}

			function setConfig(config) {
				var serverConfig = config;
				
				var fieldset = document.getElementById("fieldset");

				fieldset.innerHTML = "<legend>" + config.EventName + "</legend>";
				
				var divisions = config.Divisions;
				if(divisions.length > 1) {
					fieldset.innerHTML = "
			}

			function validatePSK() {
				var psk = document.getElementById("PSK").value;

				if(psk.length < 8 || psk.length > 63) {
					alert("WiFi PSK must be between 8 and 63 characters");
					return false;
				}
				else {
					return true;
				}
			}

			function tryConnect() {
				if(validatePSK()) {
					setStatus("Connecting...", null);

					headers = [
						{
							"name" : "psk",
							"value" : document.getElementById("PSK").value
						},
						{
							"name" : "ssid",
							"value" : document.getElementById("SSID_SEL").value
						}
					]
					httpGetAsync("try_connect", headers, function(result) {
						var parsed = JSON.parse(result);
						if(parsed.success == "true") {
							window.location.href = "/config_server.html";
						}
						else {
							setStatus("Connect Failed", "red");
						}
					});
				}
				
				return false;
			}

			function setStatus(text, color) {
				var statusNode = document.getElementById("status_text");
				if(color == null) {
					color = "black";
				}
				statusNode.innerHTML = "<font size=2 color=" + color + ">" + text + "</font>";
			}
		</script>
	</head>
	<body>
		<form onsubmit="return tryConnect()">
			<fieldset id="fieldset">
				<legend id="legend"></legend>
				
				<input type="checkbox" id="check_1">
				<label for="check_1">Field 1</label>

				<input type="submit" value="Register">
				<p id="status_text"> </p>
			</fieldset>
		</form>

		<script type="text/javascript">
			getConfig();
		</script>
	</body>
</html>
