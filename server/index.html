<html>
	<head>
		<title>WiFi Remote - WiFi Settings</title>
		<script type="text/javascript">
			function httpGetAsync(theUrl, headers, callback) {
					var xmlHttp = new XMLHttpRequest();
					xmlHttp.onreadystatechange = function() { 
							if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
									callback(xmlHttp.responseText);
					}
					xmlHttp.open("GET", theUrl, true); // true for asynchronous
					xmlHttp.setRequestHeader("Cache-Control", "no-cache");
					
					if(headers != null) {
						for(i = 0; i < headers.length; i++) {
							xmlHttp.setRequestHeader(headers[i].name, headers[i].value);
						}
					}

					xmlHttp.send(null);
			}
			function getSSIDs() {
				setStatus("Scanning...");
				httpGetAsync("station_scan", null, function(stations) {
					updateSSIDs(stations);

					setStatus("");
				});
			}

			function updateSSIDs(stations) {
				//Get the SSID Selector
				var select = document.getElementById("SSID_SEL");
				
				//Clear existing options
				while(select.firstChild) {
					select.removeChild(select.firstChild);
				}
				
				//Parse JSON
				var stationObj = JSON.parse(stations);
				var arr = stationObj.Stations;

				//Add SSIDs from JSON to select field
				for(i = 0; i < arr.length; i++) {
					var newOpt = document.createElement('option');
					newOpt.text = arr[i].SSID;
					newOpt.value = arr[i].SSID;
					select.append(newOpt);
				}
			}

			function validatePSK() {
				var psk = document.getElementById("PSK").value;

				if(psk.length < 8 || psk.length > 63) {
					alert("WiFi PSK must be between 8 and 63 characters");
					return false;
				}
				else {
					return true;
				}
			}

			function tryConnect() {
				if(validatePSK()) {
					setStatus("Connecting...", null);

					headers = [
						{
							"name" : "psk",
							"value" : document.getElementById("PSK").value
						},
						{
							"name" : "ssid",
							"value" : document.getElementById("SSID_SEL").value
						}
					]
					httpGetAsync("try_connect", headers, function(result) {
						var parsed = JSON.parse(result);
						if(parsed.success == "true") {
							window.location.href = "/config_server.html";
						}
						else {
							setStatus("Connect Failed", "red");
						}
					});
				}
				
				return false;
			}

			function setStatus(text, color) {
				var statusNode = document.getElementById("status_text");
				if(color == null) {
					color = "black";
				}
				statusNode.innerHTML = "<font size=2 color=" + color + ">" + text + "</font>";
			}
		</script>
	</head>
	<body>
		<form onsubmit="return tryConnect()">
			<fieldset>
				<legend>Access Point</legend>
				SSID:<br>
				<select name="ssid" id="SSID_SEL">
				</select>
				<button type="button" onclick="getSSIDs()">Scan</button>
				<p>
				PSK:<br>
				<input type="password" name="psk" id="PSK"><br>
				<input type="submit" value="Connect">
				<p id="status_text"> </p>
			</fieldset>
		</form>

		<script type="text/javascript">
			getSSIDs();
		</script>
	</body>
</html>
